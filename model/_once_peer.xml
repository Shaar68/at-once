<class name="_once peer" title="_once server">
    This is a client implementation of the @Once Protocol.
    <include filename="license.xml" />

    <state name="start">
        <event name="ENTER" next="authenticating" />
    </state>

    <state name="authenticating">
        <event name="WHISPER" message="CHALLENGE">
            <action name="challenge" />
            <action name="send" message="AUTHENTICATE" />
        </event>

        <event name="WHISPER" message="OK" next="connecting">
            <action name="send" message="GET ENDPOINTS" />
        </event>

        <event name="WHISPER" message="NOPE">
            <action name="stop" />
        </event>
    </state>

    <state name="updating">
        <event name="WHISPER" message="LIST ENDPOINTS" next="connecting">
            <action name="on list endpoints" />
            <action name="get next endpoint" />
            <action name="set event" value="connect" />
        </event>
    </state>

    <state name="connecting">
        <event name="connect">
            <action name="connect to remote endpoint" />
            <action name="get next endpoint" />
        </event>

        <event name="finished" next="ready" />
    </state>


    <state name="ready">
        <event name="*">
            <action name="execute" />
        </event>

        <event name="WHISPER" message="STOP">
            <action name="stop" />
        </event>
    </state>
</class>